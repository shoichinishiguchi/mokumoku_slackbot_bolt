"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/* eslint-disable @typescript-eslint/explicit-member-accessibility, @typescript-eslint/strict-boolean-expressions */
const socket_mode_1 = require("@slack/socket-mode");
const http_1 = require("http");
const logger_1 = require("@slack/logger");
const oauth_1 = require("@slack/oauth");
const render_html_for_install_path_1 = require("./render-html-for-install-path");
/**
 * Receives Events, Slash Commands, and Actions of a web socket connection
 */
class SocketModeReceiver {
    constructor({ appToken, logger = undefined, logLevel = logger_1.LogLevel.INFO, clientId = undefined, clientSecret = undefined, stateSecret = undefined, installationStore = undefined, scopes = undefined, installerOptions = {}, }) {
        this.installer = undefined;
        this.client = new socket_mode_1.SocketModeClient({
            appToken,
            logLevel,
            logger,
            clientOptions: installerOptions.clientOptions,
        });
        if (typeof logger !== 'undefined') {
            this.logger = logger;
        }
        else {
            this.logger = new logger_1.ConsoleLogger();
            this.logger.setLevel(logLevel);
        }
        if (clientId !== undefined &&
            clientSecret !== undefined &&
            (stateSecret !== undefined || installerOptions.stateStore !== undefined)) {
            this.installer = new oauth_1.InstallProvider({
                clientId,
                clientSecret,
                stateSecret,
                installationStore,
                logLevel,
                logger,
                stateStore: installerOptions.stateStore,
                authVersion: installerOptions.authVersion,
                clientOptions: installerOptions.clientOptions,
                authorizationUrl: installerOptions.authorizationUrl,
            });
        }
        // Add OAuth routes to receiver
        if (this.installer !== undefined) {
            // use default or passed in redirect path
            const redirectUriPath = installerOptions.redirectUriPath === undefined ? '/slack/oauth_redirect' : installerOptions.redirectUriPath;
            // use default or passed in installPath
            const installPath = installerOptions.installPath === undefined ? '/slack/install' : installerOptions.installPath;
            const server = http_1.createServer(async (req, res) => {
                if (req.url !== undefined && req.url.startsWith(redirectUriPath)) {
                    // call installer.handleCallback to wrap up the install flow
                    await this.installer.handleCallback(req, res, installerOptions.callbackOptions);
                }
                else if (req.url !== undefined && req.url.startsWith(installPath)) {
                    try {
                        const url = await this.installer.generateInstallUrl({
                            metadata: installerOptions.metadata,
                            scopes: scopes,
                            userScopes: installerOptions.userScopes,
                        });
                        res.writeHead(200, {});
                        res.end(render_html_for_install_path_1.renderHtmlForInstallPath(url));
                    }
                    catch (err) {
                        throw new Error(err);
                    }
                }
                else {
                    this.logger.error(`Tried to reach ${req.url} which isn't a valid route.`);
                    // Return 404 because we don't support route
                    res.writeHead(404, {});
                    res.end(`route ${req.url} doesn't exist!`);
                }
            });
            const port = installerOptions.port === undefined ? 3000 : installerOptions.port;
            this.logger.debug(`listening on port ${port} for OAuth`);
            this.logger.debug(`Go to http://localhost:${port}${installPath} to initiate OAuth flow`);
            // use port 3000 by default
            server.listen(port);
        }
        this.client.on('slack_event', async ({ ack, body }) => {
            var _a;
            const event = {
                body,
                ack,
            };
            await ((_a = this.app) === null || _a === void 0 ? void 0 : _a.processEvent(event));
        });
    }
    init(app) {
        this.app = app;
    }
    start() {
        // start socket mode client
        return this.client.start();
    }
    stop() {
        return new Promise((resolve, reject) => {
            try {
                this.client.disconnect();
                resolve();
            }
            catch (error) {
                reject(error);
            }
        });
    }
}
exports.default = SocketModeReceiver;
//# sourceMappingURL=SocketModeReceiver.js.map